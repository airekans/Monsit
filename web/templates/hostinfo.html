{% extends "base.html" %}
{% block head_js %}
<script src="static/js/echarts-plain-original.js"></script>
{% endblock %}
{% block content %}
<h1 class="page-header">{{ host_name }}<small>Host Information</small></h1>

<h2 class="sub-header">CPU</h2>
<div class="row placeholders">
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="cpu_chart" style="height:300px;"></div>
    </div>
</div>

<h2 class="sub-header">Network</h2>
<div class="row placeholders">
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="net_recv_chart" style="height:300px;"></div>
    </div>
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="net_send_chart" style="height:300px;"></div>
    </div>
</div>

<h2 class="sub-header">Memory</h2>
<div class="row placeholders">
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="vmem_chart" style="height:300px;"></div>
    </div>
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="swap_chart" style="height:300px;"></div>
    </div>
</div>

<h2 class="sub-header">Disk</h2>
<div class="row placeholders">
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="disk_io_write_chart" style="height:300px;"></div>
    </div>
    <div class="col-xs-12 col-sm-12 placeholder">
      <div id="disk_io_read_chart" style="height:300px;"></div>
    </div>
</div>
{% endblock %}

{% block body_js %}
{{ super() }}
<script>
$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
var host_id = {{ host_id }};
$(function() {
    var chart_data = {
        cpu_chart: {title: 'Usage',
                    stat_name: 'cpu', stat_id: 1
                   },
        net_recv_chart: {title: 'Recv',
                         stat_name: 'net_recv', stat_id: 2
                        },
        net_send_chart: {title: 'Send',
                         stat_name: 'net_send', stat_id: 3
                        },
        vmem_chart: {title: 'Physical Memory',
                     stat_name: 'vmem', stat_id: 4
                    },
        swap_chart: {title: 'Swap Memory',
                     stat_name: 'swap', stat_id: 5
                    },
        disk_io_write_chart: {title: 'Write',
                              stat_name: 'disk_io_write', stat_id: 6
                             },
        disk_io_read_chart: {title: 'Read',
                             stat_name: 'disk_io_read', stat_id: 7
                            }
    };
    var stat_ids = [];
    for (var chart_id in chart_data)
    {
        var tmp_data = chart_data[chart_id];
        stat_ids.push(tmp_data.stat_id);
    }

    var charts = {};
    for (var chart_id in chart_data)
    {
        var chart_dom = document.getElementById(chart_id);
        var tmp_chart = echarts.init(chart_dom);
        tmp_chart.showLoading({text: 'Loading...'});
        charts[chart_id] = tmp_chart;
    }

    $.getJSON($SCRIPT_ROOT + '/_get_hostinfo', {stat_ids: stat_ids, host_id: host_id},
        function(data) {
            for (var chart_name in chart_data)
            {
                var tmp_data = chart_data[chart_name];
                var stat_info = data.stats[tmp_data.stat_id];
                var stat = stat_info.data;
                var names = [];
                for (var name in stat)
                {
                    names.push(name);
                }
                var stat_times = [];
                var time_record = {};
                for (var t in stat[names[0]])
                {
                    stat_times.push(t);
                    time_record.latest_time = t;
                }

                var this_config = {is_auto_refresh: false, stat_id: tmp_data.stat_id,
                                   stat_names: names};
                function on_click_auto_refresh(config, chart_name, time_record) {
                    var stat_id = config.stat_id;
                    var the_chart = charts[chart_name];
                    var is_set_interval = false;
                    var time_ticket = false;
                    return function () {
                        config.is_auto_refresh = !config.is_auto_refresh;
                        if (config.is_auto_refresh) {
                            // auto refresh the chart
                            time_ticket = setInterval(function() {
                                // connect the server and try to fetch the latest data
                                var args = {id: host_id, stat_id: stat_id,
                                            latest_time: time_record.latest_time};
                                $.getJSON($SCRIPT_ROOT + '/_get_latest_info', args, function (data) {
                                    if (data.return_code == 0) {
                                        var to_add_stats = [];
                                        var stat = data.stats;
                                        var stat_names = config.stat_names;
                                        var is_first = true;
                                        for (var name in stat) {
                                            var name_i = stat_names.indexOf(name);
                                            if (name_i < 0) {
                                                continue;
                                            }

                                            for (var t in stat[name]) {
                                                var tmp = 1;
                                                if (is_first) {
                                                    tmp = [name_i, stat[name][t], false, false, t];
                                                } else {
                                                    tmp = [name_i, stat[name][t], false, false];
                                                }
                                                to_add_stats.push(tmp);
                                                time_record.latest_time = t;
                                            }

                                            is_first = false;
                                        }
                                        the_chart.addData(to_add_stats);
                                    }
                                });
                            }, 30000); // refresh every 30 seconds
                            is_set_interval = true;
                        } else {
                            // disable auto refresh
                            if (is_set_interval) {
                                alert('disable auto refresh ' + chart_name);
                                clearInterval(time_ticket);
                                is_set_interval = false;
                            }
                        }
                    }
                }

                var option = {
                    title : {
                        text: tmp_data.title
                    },
                    tooltip : {
                        trigger: 'axis'
                    },
                    legend: {
                        data: names
                    },
                    toolbox: {
                        show : true,
                        feature : {
                            mark : {show: true},
                            dataZoom : {show: true},
                            dataView : {show: true, readOnly: false},
                            magicType : {show: true, type: ['line', 'bar']},
                            saveAsImage : {show: true},
                            autoRefresh : {show: true, title: '自动刷新',
                                           icon: 'image://static/img/octicons-sync.png',
                                           onclick: on_click_auto_refresh(this_config, chart_name, time_record)}
                        }
                    },
                    dataZoom : {
                        show : true,
                        realtime : true,
                        y : 280,
                        height : 20
                    },
                    calculable : true,
                    xAxis : [
                        {
                            type : 'category',
                            boundaryGap : false,
                            data : stat_times
                        }
                    ],
                    yAxis : [
                        {
                            type : 'value',
                            axisLabel : {
                                formatter: '{value} ' + stat_info.unit
                            },
                            splitArea : {show : true}
                        }
                    ],
                    series : []
                };

                for (var name in stat)
                {
                    var tmp_stat = stat[name];
                    var stat_data = [];
                    for (var st in tmp_stat)
                    {
                        stat_data.push(tmp_stat[st]);
                    }

                    option.series.push({
                        name: name,
                        type: 'line',
                        data: stat_data,
                        markPoint : {
                            data : [
                                {type : 'max', name: 'max'},
                                {type : 'min', name: 'min'}
                            ]
                        }
                    });
                }
                charts[chart_name].hideLoading();
                charts[chart_name].setOption(option);
            }
        });
});
</script>
{% endblock %}
